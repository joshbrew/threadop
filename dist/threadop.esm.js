function A(s=y=>y,{imports:u,functions:h,message:c,transfer:O,port:e,blocking:a,pool:d,loop:o,animate:E,callback:W}={}){return new Promise((y,M)=>{let P;if(typeof s!="function"){if(typeof s=="string"&&s.startsWith("./")){let l=location.origin,i=location.pathname.split("/");i.pop();let T=i.join("/");T.startsWith("http")?l+="/":l+=T+"/",s=l+s}P=s}else P=v(s,u,h);let D=l=>{let i={},T=!1;l.onmessage=n=>{for(let b in i)i[b](n.data.message,n.data.cb)},l.onerror=n=>{console.error(new Error("Worker encountered an error: "+n.message))};let R=(n,b,r,t)=>new Promise((f,m)=>{if(!r&&l.PORTS)l.postMessage({message:n,overridePort:r,fnName:t},b),f(!0);else{if(a){if(T)return new Promise((k,S)=>{S("Thread Blocked")});T=!0}let p=Math.floor(Math.random()*1e15);i[p]=(k,S)=>{p===S&&(delete i[p],a&&(T=!1),f(k))},l.postMessage({message:n,cb:p,overridePort:r},b)}}),g={run:(n,b,r)=>R(n,b,r),terminate:()=>{if(URL.revokeObjectURL(P),l.terminate(),l.PORTS){let n=(b,r)=>{b.postMessage({COMMAND:{DELETED:l.id}})};l.PORTS.forEach(n)}},addPort:n=>K(l,n,a),addCallback:(n=t=>{},b,r)=>{let t=Math.floor(Math.random()*1e15);return i[t]=b||r?(f,m)=>{(!r||m===r)&&n(f),b&&delete i[t]}:n,t},set:(n,b)=>(typeof n=="function"&&(n=n.toString()),R({setFunction:n,setFunctionName:b})),call:(n,b,r,t)=>R(b,r,t,n),removeCallback:n=>{delete g.callbacks[n]},setLoop:(n,b,r)=>{l.postMessage({message:b,COMMAND:{SETLOOP:n}},r)},setAnimation:(n,b)=>{l.postMessage({message:n,COMMAND:{SETANIM:!0}},b)},stop:()=>{l.postMessage({COMMAND:{STOP:!0}})},worker:l,callbacks:i,id:l.id};return W&&g.addCallback(W),o?g.setLoop(o,c,O):E&&g.setAnimation(c,O),g};if(d){let T=function(){let g=new Worker(P,u||typeof s!="function"?{type:"module"}:void 0),n=Math.floor(Math.random()*1e15);return g.id=n,l[n]=g,n},l={},i={};for(let g=0;g<d;g++)T();let R=Object.keys(l);if(e&&R.forEach((g,n)=>{let b=l[g];Array.isArray(e)?e.length===R.length?K(b,e[n],a):e.forEach(r=>{K(b,r,a)}):K(b,e,a)}),c&&!o&&!E)Promise.all(R.map((g,n)=>{let b=l[g],r=Array.isArray(c)?c[n]:c;return new Promise((t,f)=>{b.onmessage=p=>{Promise.resolve().then(()=>{b.terminate(),delete l[b.id]}),t(p.data.message)},b.onerror=p=>{Promise.resolve().then(()=>{b.terminate(),delete l[b.id]}),f(new Error("Worker encountered an error: "+p.message))};let m={message:r,oneOff:!0};b.postMessage(m,O)})})).then(g=>{URL.revokeObjectURL(P),y(g)}).catch(g=>{URL.revokeObjectURL(P),Object.keys(l).map((n,b)=>{let r=l[n];r&&r.terminate(),delete l[n],delete i.helpers?.[n]}),M(g)});else{let g=0,n=(r,t,f,m,p)=>{if(p)return m?i.helpers[p]?.call(m,r,t):i.helpers[p]?.run(r,t);if(Array.isArray(r)){let k=r.length,S=new Array(k);for(let N=0;N<k;N++){let C;m?C=i.helpers[p]?.call(m,r[N],t[N]):C=i.helpers[R[g]].run(r[N],t[N],f),g++,g>=R.length&&(g=0),S[N]=C}return S}else{let k;return m?k=i.helpers[R[g]].call(m,r,t,f):k=i.helpers[R[g]].run(r,t,f),g++,g>=R.length&&(g=0),k}};Object.assign(i,{workers:l,helpers:{},keys:R,run:(r,t,f,m)=>n(r,t,f,void 0,m),terminate:r=>{function t(f){i.helpers[f]?.terminate(),delete i.helpers[f],delete i.workers[f]}r?t(r):R.forEach(t)},set:(r,t)=>(typeof r=="function"&&(r=r.toString()),n({setFunction:r,setFunctionName:t})),call:(r,t,f,m,p)=>n(t,f,m,r,p),addWorker:()=>{let r=T(),t=l[r];return b(t),R.length=0,R.push(...R),r},addPort:(r,t)=>{function f(m){return i.helpers[m]?.addPort(r),!0}return t?f(t):R.map(f)},addCallback:(r,t,f,m)=>{function p(k){return i.helpers[k]?.addCallback(r,t,f)}return m?p(m):R.map(p)},removeCallback:(r,t)=>{function f(m){return i.helpers[m]?.removeCallback(r),!0}return t?f(t):R.map(f)},setLoop:(r,t,f,m)=>{function p(k){i.helpers[k]?.setLoop(r,t,f)}return m?p(m):R.map(p)},setAnimation:(r,t,f)=>{function m(p){i.helpers[p]?.setAnimation(r,t)}return f?m(f):R.map(m)},stop:r=>{function t(f){i.helpers[f]?.stop()}return r?t(r):R.map(t)}});let b=r=>{i.helpers[r.id]=D(r)};Object.keys(l).forEach((r,t)=>{b(l[r])}),y(i)}}else{let l=Math.floor(Math.random()*1e15),i=new Worker(P,u||typeof s!="function"?{type:"module"}:void 0);if(i.id=l,e&&(e.id||(e.id=Math.floor(Math.random()*1e15)),Array.isArray(e)?e.map(T=>{K(i,T,a)}):K(i,e,a)),c&&!o&&!E)i.onmessage=T=>{Promise.resolve().then(()=>{i.terminate(),URL.revokeObjectURL(P)}),y(T.data.message)},i.onerror=T=>{Promise.resolve().then(()=>{i.terminate(),URL.revokeObjectURL(P)}),M(new Error("Worker encountered an error: "+T.message))},i.postMessage({message:c,oneOff:!0},O);else{let T=D(i);y(T)}}})}function F(s){let u=location.pathname.split("/");u.pop();let h=location.origin+u.join("/")+"/";return typeof s=="string"?(s.startsWith("./")&&(s=h+s),s.includes("import")?`${s}`:`import '${s}';`):Array.isArray(s)?s.map(c=>(c.startsWith("./")&&(c=h+c),c.includes("import")?c:`import '${c}';`)).join(`
`):typeof s=="object"?Object.entries(s).map(([O,e])=>(O.startsWith("./")&&(O=h+O),typeof e=="string"?`import ${e} from '${O}';`:typeof e=="boolean"&&e?`import '${O}'`:`import { ${Object.entries(e).map(([d,o])=>typeof o=="string"?`${d} as ${o}`:d).join(", ")} } from '${O}';`)).join(`
`)+"":""}function K(s,u,h){let c=new MessageChannel;s.id||(s.id=Math.floor(Math.random()*1e15)),u.id||(u.id=Math.floor(Math.random()*1e15)),s.postMessage({COMMAND:{SENDER:c.port1,id:u.id,blocking:h}},[c.port1]),u.postMessage({COMMAND:{RECEIVER:c.port2,id:s.id,blocking:h}},[c.port2]),s.PORTS||(s.PORTS=[]),s.PORTS.push(u),u.PORTS||(u.PORTS=[]),u.PORTS.push(s)}var x=(s=()=>{},u={dummy:()=>{}})=>{globalThis.WORKER={FUNCTIONS:u},u&&Object.keys(u).forEach(e=>{u[e]=u[e].bind(globalThis.WORKER)});function h(e=""){let a=y=>{let M=y.indexOf("=>")+1;return M<=0&&(M=y.indexOf("){")),M<=0&&(M=y.indexOf(") {")),y.slice(0,y.indexOf("{",M)+1)},d=y=>y.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),o=a(e),E=d(e),W;if(o.includes("function")){let y=o.substring(o.indexOf("(")+1,o.lastIndexOf(")"));W=new Function(y,E)}else if(o.substring(0,6)===E.substring(0,6)){let y=o.substring(o.indexOf("(")+1,o.lastIndexOf(")"));W=new Function(y,E.substring(E.indexOf("{")+1,E.length-1))}else try{W=(0,eval)(e)}catch{}return W}s=s.bind(globalThis.WORKER);let c=(e,a,d,o,E)=>{if(globalThis.WORKER.SENDERS&&o!==!0)if(o!==void 0&&o!=="both")globalThis.WORKER.SENDERS[o]&&(e?.message?globalThis.WORKER.SENDERS[o].postMessage({message:e.message,overridePort:e?.overridePort,fnName:e?.fnName},e.transfer):globalThis.WORKER.SENDERS[o].postMessage({message:e,overridePort:e?.overridePort,fnName:e?.fnName}));else{for(let W in globalThis.WORKER.SENDERS){if(globalThis.WORKER.BLOCKING[W]){if(globalThis.WORKER.BLOCKED[W]){console.error("Thread Blocked: "+W);continue}globalThis.WORKER.BLOCKED[W]=!0}e?.message?globalThis.WORKER.SENDERS[W].postMessage({message:e.message,overridePort:e?.overridePort,fnName:e?.fnName},e.transfer):globalThis.WORKER.SENDERS[W].postMessage({message:e,overridePort:e?.overridePort,fnName:e?.fnName})}d&&postMessage(!0)}(!globalThis.WORKER.SENDERS||o===!0||o==="both")&&(e?.message?postMessage({message:e.message,cb:a,overridePort:e?.overridePort,fnName:E},e.transfer):postMessage({message:e,cb:a,overridePort:e?.overridePort,fnName:E}))},O=(e,a)=>{let d;if(e.data.setFunction){let o=h(e.data.setFunction).bind(globalThis.WORKER),E=e.data.setFunctionName||Math.floor(Math.random()*1e15);d=E,globalThis.WORKER.FUNCTIONS[E]=o}else if(e.data.fnName){let o=globalThis.WORKER.FUNCTIONS[e.data.fnName];o&&(d=o(e.data?.message))}else d=s(e.data?.message);d?.then?d.then(o=>{a&&a.postMessage(!0),c(o,e.data.cb,e.data.oneOff,e.data.overridePort,e.data.fnName)}):(a&&a.postMessage(!0),c(d,e.data.cb,e.data.oneOff,e.data.overridePort,e.data.fnName))};globalThis.onmessage=e=>{if(e.data?.COMMAND){let a=e.data.COMMAND;if(typeof a.SETLOOP=="number"){globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP);let d=()=>{O(e),globalThis.WORKER.LOOP=setTimeout(()=>{d()},a.SETLOOP)};d()}if(a.SETANIM){globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM);let d=()=>{O(e),globalThis.WORKER.ANIM=requestAnimationFrame(()=>{d()})};d()}if(a.STOP&&(globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP),globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM)),a.RECEIVER){let d=a.blocking;globalThis.WORKER.RECEIVERS||(globalThis.WORKER.RTCR=0,globalThis.WORKER.RECEIVERS={});let o=a.id;globalThis.WORKER.RECEIVERS[o]=a.RECEIVER,globalThis.WORKER.RTCR++,a.RECEIVER.onmessage=E=>{O(E,d?a.RECEIVER:void 0)},a.RECEIVER.onerror=E=>{delete globalThis.WORKER.RECEIVERS[o]}}if(a.SENDER){globalThis.WORKER.SENDERS||(globalThis.WORKER.PCTR=0,globalThis.WORKER.SENDERS={},globalThis.WORKER.BLOCKING={},globalThis.WORKER.BLOCKED={});let d=a.blocking,o=a.id?a.id:globalThis.WORKER.PCTR;globalThis.WORKER.SENDERS[o]=a.SENDER,globalThis.WORKER.PCTR++,d&&(globalThis.WORKER.BLOCKING[o]=!0),a.SENDER.onmessage=E=>{globalThis.WORKER.BLOCKING[o]&&(globalThis.WORKER.BLOCKED[o]=!1)},a.SENDER.onerror=E=>{delete globalThis.WORKER.SENDERS[o]}}a.DELETED&&(delete globalThis.WORKER.RECEIVERS?.[a.DELETED],delete globalThis.WORKER.SENDERS?.[a.DELETED])}else O(e)},globalThis.onerror=e=>{console.error(e)}},I=x.toString(),v=(s=()=>{},u,h)=>{let c=I.replace("()=>{}",s.toString());h&&I.replace("{dummy:()=>{}}",JSON.stringify(L(h)));let e=`${F(u)}

(${c})()`,a=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(a)},L=s=>{let u={};for(let h in s)typeof s[h]=="object"?u[h]=L(s[h]):typeof s[h]=="function"?u[h]=s[h].toString():u[h]=s[h];return u},B=A;export{B as default,v as generateWorkerURL,x as initWorker,L as recursivelyStringifyFunctions,A as threadop,I as workerFnString};
