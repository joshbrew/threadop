function M(i=W=>W,{imports:d,message:p,transfer:t,port:r,blocking:l,pool:f,loop:E,animate:T,callback:k}={}){return new Promise((W,P)=>{let h;if(typeof i!="function"){if(typeof i=="string"&&i.startsWith("./")){let o=location.origin,a=location.pathname.split("/");a.pop();let c=a.join("/");c.startsWith("http")?o+="/":o+=c+"/",i=o+i}h=i}else h=D(i,d);let S=o=>{let a={},c=!1;o.onmessage=s=>{for(let e in a)a[e](s.data.message,s.data.cb)},o.onerror=s=>{console.error(new Error("Worker encountered an error: "+s.message))};let R=(s,e)=>new Promise((n,m)=>{if(o.PORTS)o.postMessage({message:s},e),n(!0);else{if(l){if(c)return new Promise((g,O)=>{O("Thread Blocked")});c=!0}let u=Math.random();a[u]=(g,O)=>{u===O&&(delete a[u],l&&(c=!1),n(g))},o.postMessage({message:s,cb:u},e)}}),b={run:(s,e)=>R(s,e),terminate:()=>{if(URL.revokeObjectURL(h),o.terminate(),o.PORTS){let s=(e,n)=>{e.postMessage({COMMAND:{DELETED:o.id}})};o.PORTS.forEach(s)}},addPort:s=>y(o,s,o.id,l),addCallback:(s=n=>{},e)=>{let n=Math.random();return a[n]=e?m=>{s(m),delete a[n]}:s,n},removeCallback:s=>{delete b.callbacks[s]},setLoop:(s,e,n)=>{o.postMessage({message:e,COMMAND:{SETLOOP:s}},n)},setAnimation:(s,e)=>{o.postMessage({message:s,COMMAND:{SETANIM:!0}},e)},stop:()=>{o.postMessage({COMMAND:{STOP:!0}})},worker:o,callbacks:a};return k&&b.addCallback(k),E?b.setLoop(E,p,t):T&&b.setAnimation(p,t),b};if(f){let c=function(){let b=new Worker(h,d||typeof i!="function"?{type:"module"}:void 0),s=Math.random();return b.id=s,o[s]=b,s},o={},a={};for(let b=0;b<f;b++)c();let R=Object.keys(o);if(r&&R.forEach((b,s)=>{let e=o[b];Array.isArray(r)?y(e,r[s],e.id,l):y(e,r,e.id,l)}),p&&!E&&!T)Promise.all(R.map((b,s)=>{let e=o[b],n=Array.isArray(p)?p[s]:p;return new Promise((m,u)=>{e.onmessage=O=>{Promise.resolve().then(()=>{e.terminate(),delete o[e.id]}),m(O.data.message)},e.onerror=O=>{Promise.resolve().then(()=>{e.terminate(),delete o[e.id]}),u(new Error("Worker encountered an error: "+O.message))};let g={message:n,oneOff:!0};e.postMessage(g,t)})})).then(b=>{URL.revokeObjectURL(h),W(b)}).catch(b=>{URL.revokeObjectURL(h),Object.keys(o).map((s,e)=>{let n=o[s];n&&n.terminate(),delete o[s],delete a.helpers?.[s]}),P(b)});else{let b=0;Object.assign(a,{workers:o,helpers:{},keys:R,run:(e,n,m)=>{if(m)a.helpers[m]?.run(e,n);else if(Array.isArray(e)){let u=e.length;for(let g=0;g<u;g++)a.helpers[R[b]].run(e[g],n[g]),b++,b>=R.length&&(b=0)}else a.helpers[R[b]].run(e,n),b++,b>=R.length&&(b=0)},terminate:e=>{function n(m){a.helpers[m]?.terminate(),delete a.helpers[m],delete a.workers[m]}e?n(e):R.forEach(n)},addWorker:()=>{let e=c(),n=o[e];return s(n),R.length=0,R.push(...R),e},addPort:(e,n)=>{function m(u){return a.helpers[u]?.addPort(e),!0}return n?m(n):R.map(m)},addCallback:(e,n,m)=>{function u(g){return a.helpers[g]?.addCallback(e,n)}return m?u(m):R.map(u)},removeCallback:(e,n)=>{function m(u){return a.helpers[u]?.removeCallback(e),!0}return n?m(n):R.map(m)},setLoop:(e,n,m,u)=>{function g(O){a.helpers[O]?.setLoop(e,n,m)}return u?g(u):R.map(g)},setAnimation:(e,n,m)=>{function u(g){a.helpers[g]?.setAnimation(e,n)}return m?u(m):R.map(u)},stop:e=>{function n(m){a.helpers[m]?.stop()}return e?n(e):R.map(n)}});let s=e=>{a.helpers[e.id]=S(e)};Object.keys(o).forEach((e,n)=>{s(o[e])}),W(a)}}else{let o=Math.random(),a=new Worker(h,d||typeof i!="function"?{type:"module"}:void 0);if(a.id=o,r&&(Array.isArray(r)?r.map(c=>{y(a,c,o,l)}):y(a,r,o,l)),p&&!E&&!T)a.onmessage=c=>{Promise.resolve().then(()=>{a.terminate(),URL.revokeObjectURL(h)}),W(c.data.message)},a.onerror=c=>{Promise.resolve().then(()=>{a.terminate(),URL.revokeObjectURL(h)}),P(new Error("Worker encountered an error: "+c.message))},a.postMessage({message:p,oneOff:!0},t);else{let c=S(a);W(c)}}})}function K(i){let d=location.pathname.split("/");d.pop();let p=location.origin+d.join("/")+"/";return typeof i=="string"?(i.startsWith("./")&&(i=p+i),i.includes("import")?`${i}`:`import '${i}';`):Array.isArray(i)?i.map(t=>(t.startsWith("./")&&(t=p+t),t.includes("import")?t:`import '${t}';`)).join(`
`):typeof i=="object"?Object.entries(i).map(([r,l])=>(r.startsWith("./")&&(r=p+r),typeof l=="string"?`import ${l} from '${r}';`:typeof l=="boolean"&&l?`import '${r}'`:`import { ${Object.entries(l).map(([E,T])=>typeof T=="string"?`${E} as ${T}`:E).join(", ")} } from '${r}';`)).join(`
`)+"":""}function y(i,d,p,t){let r=new MessageChannel;i.postMessage({COMMAND:{SENDER:r.port1,id:p,blocking:t}},[r.port1]),d.postMessage({COMMAND:{RECEIVER:r.port2,id:p,blocking:t}},[r.port2]),i.PORTS||(i.PORTS=[]),i.PORTS.push(d),d.PORTS||(d.PORTS=[]),d.PORTS.push(i)}var C=(i=()=>{})=>{globalThis.WORKER={};let d=(t,r,l)=>{if(globalThis.WORKER.SENDERS)for(let f in globalThis.WORKER.SENDERS){if(globalThis.WORKER.BLOCKING[f]){if(globalThis.WORKER.BLOCKED[f]){console.error("Thread Blocked: "+f);continue}globalThis.WORKER.BLOCKED[f]=!0}t?.message&&t?.transfer?globalThis.WORKER.SENDERS[f].postMessage({message:t.message,cb:r},t.transfer):globalThis.WORKER.SENDERS[f].postMessage({message:t,cb:r}),l&&postMessage(!0)}else t?.message&&t?.transfer?postMessage({message:t.message,cb:r},t.transfer):postMessage({message:t,cb:r})},p=(t,r)=>{let l=i(t.data?.message);l?.then?l.then(f=>{r&&r.postMessage(!0),d(f,t.data.cb,t.data.oneOff)}):(r&&r.postMessage(!0),d(l,t.data.cb,t.data.oneOff))};globalThis.onmessage=t=>{if(t.data?.COMMAND){let r=t.data.COMMAND;if(typeof r.SETLOOP=="number"){globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP);let l=()=>{p(t),globalThis.WORKER.LOOP=setTimeout(()=>{l()},r.SETLOOP)};l()}if(r.SETANIM){globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM);let l=()=>{p(t),globalThis.WORKER.ANIM=requestAnimationFrame(()=>{l()})};l()}if(r.STOP&&(globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP),globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM)),r.RECEIVER){let l=r.blocking;globalThis.WORKER.RECEIVERS||(globalThis.WORKER.RTCR=0,globalThis.WORKER.RECEIVERS={});let f=r.id;globalThis.WORKER.RECEIVERS[f]=r.RECEIVER,globalThis.WORKER.RTCR++,r.RECEIVER.onmessage=E=>{p(E,l?r.RECEIVER:void 0)},r.RECEIVER.onerror=E=>{delete globalThis.WORKER.RECEIVERS[f]}}if(r.SENDER){globalThis.WORKER.SENDERS||(globalThis.WORKER.PCTR=0,globalThis.WORKER.SENDERS={},globalThis.WORKER.BLOCKING={},globalThis.WORKER.BLOCKED={});let l=r.blocking,f=r.id?r.id:globalThis.WORKER.PCTR;globalThis.WORKER.SENDERS[f]=r.SENDER,globalThis.WORKER.PCTR++,l&&(globalThis.WORKER.BLOCKING[f]=!0),r.SENDER.onmessage=E=>{globalThis.WORKER.BLOCKING[f]&&(globalThis.WORKER.BLOCKED[f]=!1)},r.SENDER.onerror=E=>{delete globalThis.WORKER.SENDERS[f]}}r.DELETED&&(delete globalThis.WORKER.RECEIVERS?.[r.DELETED],delete globalThis.WORKER.SENDERS?.[r.DELETED])}else p(t)},globalThis.onerror=t=>{console.error(t)}},L=C.toString(),D=(i,d)=>{let p=L.replace("()=>{}",i.toString()),r=`${K(d)}
(${p})()`,l=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(l)},I=M;export{I as default,D as generateWorkerURL,C as initWorker,M as threadop,L as workerFnString};
