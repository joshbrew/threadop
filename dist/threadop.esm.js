function L(p=T=>T,{imports:c,message:u,transfer:R,port:m,blocking:f,pool:W,loop:E,animate:O,callback:k}={}){return new Promise((T,P)=>{let M=(()=>{globalThis.WORKER={};let s=(i,a,n)=>{if(globalThis.WORKER.SENDERS)for(let r in globalThis.WORKER.SENDERS){if(globalThis.WORKER.BLOCKING[r]){if(globalThis.WORKER.BLOCKED[r]){console.error("Thread Blocked: "+r);continue}globalThis.WORKER.BLOCKED[r]=!0}globalThis.WORKER.SENDERS[r].postMessage({message:i,cb:a}),n&&postMessage(!0)}else postMessage({message:i,cb:a})},t=(i,a)=>{let n=(()=>{})(i.data?.message);n?.then?n.then(r=>{a&&a.postMessage(!0),s(r,i.data.cb,i.data.oneOff)}):(a&&a.postMessage(!0),s(n,i.data.cb,i.data.oneOff))};globalThis.onmessage=i=>{if(i.data?.COMMAND){let a=i.data.COMMAND;if(typeof a.SETLOOP=="number"){globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP);let n=()=>{t(i),globalThis.WORKER.LOOP=setTimeout(()=>{n()},a.SETLOOP)};n()}if(a.SETANIM){globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM);let n=()=>{t(i),globalThis.WORKER.ANIM=requestAnimationFrame(()=>{n()})};n()}if(a.STOP&&(globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP),globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM)),a.RECEIVER){let n=a.blocking;globalThis.WORKER.RECEIVERS||(globalThis.WORKER.RTCR=0,globalThis.WORKER.RECEIVERS={});let r=a.id;globalThis.WORKER.RECEIVERS[r]=a.RECEIVER,globalThis.WORKER.RTCR++,a.RECEIVER.onmessage=e=>{t(e,n?a.RECEIVER:void 0)},a.RECEIVER.onerror=e=>{delete globalThis.WORKER.RECEIVERS[r]}}if(a.SENDER){globalThis.WORKER.SENDERS||(globalThis.WORKER.PCTR=0,globalThis.WORKER.SENDERS={},globalThis.WORKER.BLOCKING={},globalThis.WORKER.BLOCKED={});let n=a.blocking,r=a.id?a.id:globalThis.WORKER.PCTR;globalThis.WORKER.SENDERS[r]=a.SENDER,globalThis.WORKER.PCTR++,n&&(globalThis.WORKER.BLOCKING[r]=!0),a.SENDER.onmessage=e=>{globalThis.WORKER.BLOCKING[r]&&(globalThis.WORKER.BLOCKED[r]=!1)},a.SENDER.onerror=e=>{delete globalThis.WORKER.SENDERS[r]}}a.DELETED&&(delete globalThis.WORKER.RECEIVERS?.[a.DELETED],delete globalThis.WORKER.SENDERS?.[a.DELETED])}else t(i)},globalThis.onerror=i=>{console.error(i)}}).toString().replace("()=>{}",p.toString()),K=`${I(c)}
(${M})()`,C=new Blob([K],{type:"application/javascript"}),h=URL.createObjectURL(C),S=s=>{let t={},i=!1;s.onmessage=r=>{for(let e in t)t[e](r.data.message,r.data.cb)},s.onerror=r=>{console.error(new Error("Worker encountered an error: "+r.message))};let a=(r,e)=>new Promise((o,l)=>{if(s.PORTS)s.postMessage({message:r},e),o(!0);else{if(f){if(i)return new Promise((d,g)=>{g("Thread Blocked")});i=!0}let b=Math.random();t[b]=(d,g)=>{b===g&&(delete t[b],f&&(i=!1),o(d))},s.postMessage({message:r,cb:b},e)}}),n={run:(r,e)=>a(r,e),terminate:()=>{if(URL.revokeObjectURL(h),s.terminate(),s.PORTS){let r=(e,o)=>{e.postMessage({COMMAND:{DELETED:s.id}})};s.PORTS.forEach(r)}},addPort:r=>y(s,r,s.id,f),addCallback:(r=o=>{},e)=>{let o=Math.random();return t[o]=e?l=>{r(l),delete t[o]}:r,o},removeCallback:r=>{delete n.callbacks[r]},setLoop:(r,e,o)=>{s.postMessage({message:e,COMMAND:{SETLOOP:r}},o)},setAnimation:(r,e)=>{s.postMessage({message:r,COMMAND:{SETANIM:!0}},e)},stop:()=>{s.postMessage({COMMAND:{STOP:!0}})},worker:s,callbacks:t};return k&&n.addCallback(k),E?n.setLoop(E,u,R):O&&n.setAnimation(u,R),n};if(W){let i=function(){let n=new Worker(h,c?{type:"module"}:void 0),r=Math.random();return n.id=r,s[r]=n,r},s={},t={};for(let n=0;n<W;n++)i();let a=Object.keys(s);if(m&&a.forEach((n,r)=>{let e=s[n];Array.isArray(m)?y(e,m[r],e.id,f):y(e,m,e.id,f)}),u&&!E&&!O)Promise.all(a.map((n,r)=>{let e=s[n],o=Array.isArray(u)?u[r]:u;return new Promise((l,b)=>{e.onmessage=g=>{Promise.resolve().then(()=>{e.terminate(),delete s[e.id]}),l(g.data.message)},e.onerror=g=>{Promise.resolve().then(()=>{e.terminate(),delete s[e.id]}),b(new Error("Worker encountered an error: "+g.message))};let d={message:o,oneOff:!0};e.postMessage(d,R)})})).then(n=>{URL.revokeObjectURL(h),T(n)}).catch(n=>{URL.revokeObjectURL(h),Object.keys(s).map((r,e)=>{let o=s[r];o&&o.terminate(),delete s[r],delete t.helpers?.[r]}),P(n)});else{let n=0;Object.assign(t,{workers:s,helpers:{},keys:a,run:(e,o,l)=>{if(l)t.helpers[l]?.run(e,o);else if(Array.isArray(e)){let b=e.length;for(let d=0;d<b;d++)t.helpers[a[n]].run(e[d],o[d]),n++,n>=a.length&&(n=0)}else t.helpers[a[n]].run(e,o),n++,n>=a.length&&(n=0)},terminate:e=>{function o(l){t.helpers[l]?.terminate(),delete t.helpers[l],delete t.workers[l]}e?o(e):a.forEach(o)},addWorker:()=>{let e=i(),o=s[e];return r(o),a.length=0,a.push(...a),e},addPort:(e,o)=>{function l(b){return t.helpers[b]?.addPort(e),!0}return o?l(o):a.map(l)},addCallback:(e,o,l)=>{function b(d){return t.helpers[d]?.addCallback(e,o)}return l?b(l):a.map(b)},removeCallback:(e,o)=>{function l(b){return t.helpers[b]?.removeCallback(e),!0}return o?l(o):a.map(l)},setLoop:(e,o,l,b)=>{function d(g){t.helpers[g]?.setLoop(e,o,l)}return b?d(b):a.map(d)},setAnimation:(e,o,l)=>{function b(d){t.helpers[d]?.setAnimation(e,o)}return l?b(l):a.map(b)},stop:e=>{function o(l){t.helpers[l]?.stop()}return e?o(e):a.map(o)}});let r=e=>{t.helpers[e.id]=S(e)};Object.keys(s).forEach((e,o)=>{r(s[e])}),T(t)}}else{let s=Math.random(),t=new Worker(h,c?{type:"module"}:void 0);if(t.id=s,m&&(Array.isArray(m)?m.map(i=>{y(t,i,s,f)}):y(t,m,s,f)),u&&!E&&!O)t.onmessage=i=>{Promise.resolve().then(()=>{t.terminate(),URL.revokeObjectURL(h)}),T(i.data.message)},t.onerror=i=>{Promise.resolve().then(()=>{t.terminate(),URL.revokeObjectURL(h)}),P(new Error("Worker encountered an error: "+i.message))},t.postMessage({message:u,oneOff:!0},R);else{let i=S(t);T(i)}}})}function I(p){let c=location.pathname.split("/");c.pop();let u=location.origin+c.join("/")+"/";return typeof p=="string"?(p.startsWith("./")&&(p=u+p),p.includes("import")?`${p}`:`import '${p}';`):Array.isArray(p)?p.map(R=>(R.startsWith("./")&&(R=u+R),R.includes("import")?R:`import '${R}';`)).join(`
`):typeof p=="object"?Object.entries(p).map(([m,f])=>(m.startsWith("./")&&(m=u+m),typeof f=="string"?`import ${f} from '${m}';`:typeof f=="boolean"&&f?`import '${m}'`:`import { ${Object.entries(f).map(([E,O])=>typeof O=="string"?`${E} as ${O}`:E).join(", ")} } from '${m}';`)).join(`
`)+"":""}function y(p,c,u,R){let m=new MessageChannel;p.postMessage({COMMAND:{SENDER:m.port1,id:u,blocking:R}},[m.port1]),c.postMessage({COMMAND:{RECEIVER:m.port2,id:u,blocking:R}},[m.port2]),p.PORTS||(p.PORTS=[]),p.PORTS.push(c),c.PORTS||(c.PORTS=[]),c.PORTS.push(p)}var N=L;export{N as default,L as threadop};
